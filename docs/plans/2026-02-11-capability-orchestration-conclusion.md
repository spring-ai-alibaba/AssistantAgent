# 能力编排与动态注册改造结论（2026-02-11）

## 1. 本次确认结论

- 目标：从“工作汇报特化流程”升级为“通用能力编排”，统一支持工作汇报、请假、会议室预定等能力。
- 路线：
  - 第一阶段：YAML 配置驱动，先打通单实例。
  - 第二阶段：DB 热更新（新增能力）。
- 热更新策略：
  - 仅支持新增，不考虑修改和删除。
  - 进行中的会话绑定旧定义直到结束；新会话命中新能力。
- 发布模型：
  - 采用 A 方案：通过注册接口发起，先落库，再加载到运行时内存。
  - 先不考虑多实例同步，仅打通单实例。

## 2. 现状问题

- 槽位续填逻辑特化到 `submit_office_work_report`，无法复用到其他能力。
- 工具结果直出逻辑特化到工作汇报，新增能力需复制代码。
- Fast Intent 与能力注册解耦不够，新增能力的识别与续填路径不统一。
- 动态能力虽然可注册工具，但缺少统一的“能力定义 -> 会话状态机 -> 续填/确认/直出”编排层。

## 3. 目标架构（可演进）

- 引入通用能力编排层：
  - `CapabilityIntentRouter`：识别能力并绑定会话。
  - `CapabilityDraftResumeReactHook`：按会话绑定能力做槽位续填。
  - `CapabilityDirectReplyModelHook`：按状态直出消息。
- 引入运行时能力索引：
  - `CapabilityRuntimeRegistry` 作为内存快照，支持新增能力加载。
- 定义统一会话键：
  - `active_capability_key`
  - `active_tool_name`
  - `draft_slots`
  - `draft_status`
- 执行层先复用 `RegisteredHttpFormCodeactTool`，避免大规模重写。

## 4. 第一阶段实现边界（本轮先做）

- 先不引入 DB 热更新全链路。
- 先把 Hook 从“工作汇报特化”改成“通用能力状态机”：
  - 任意 `capability_draft_{tool}_status` 都可续填。
  - 任意能力工具返回 `SLOT_MISSING/WAIT_CONFIRM/SUBMITTED/SUBMIT_FAILED` 都可直出。
- 槽位识别统一走 LLM，禁止正则硬编码业务字段。
- 保持现有工具协议不变，降低改造风险。

## 5. 第二阶段预留（后续实现）

- 新增 `POST /capabilities/register`：
  - 校验 -> 事务落库 -> 提交后内存加载。
- 引入 append-only 能力定义表与唯一键约束。
- 新会话命中新能力；旧会话按旧绑定继续执行。

## 6. 执行计划（第一批）

1. 将草稿续填 Hook 泛化为按 `toolName` 运行，不再写死工作汇报工具名。
2. 将工具结果直出 Hook 泛化为按标准状态处理任意能力工具。
3. 抽取通用槽位提取提示词模板，按当前能力动态传入字段集合。
4. 增加请假/会议室预定场景单测，验证“新增能力无需改代码”。
5. 保持现有工作汇报用例全部通过，确保无回归。

## 7. 验收标准

- 新增能力只需配置，不需新增特化 Hook 代码。
- 同一轮内可正确执行：
  - 缺字段追问
  - 收集完成确认
  - 提交成功/失败提示
- 工作汇报、请假、会议室预定三类能力在同一编排链路下通过测试。
